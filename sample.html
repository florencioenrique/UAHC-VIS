<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global & PH Address Selector</title>
    <style>
        body { font-family: 'Inter', sans-serif; background: #f4f7f9; padding: 40px; color: #333; }
        .address-card { max-width: 450px; margin: auto; background: #fff; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
        h2 { margin-bottom: 20px; font-size: 1.5rem; color: #1a73e8; text-align: center; }
        .field { margin-bottom: 18px; }
        label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 6px; color: #555; }
        select, input { width: 100%; padding: 12px; border: 1px solid #d1d9e0; border-radius: 8px; font-size: 14px; box-sizing: border-box; transition: all 0.2s; }
        select:focus { border-color: #1a73e8; box-shadow: 0 0 0 3px rgba(26,115,232,0.1); outline: none; }
        select:disabled { background: #f0f2f5; cursor: not-allowed; opacity: 0.7; }
        .brgy-container { display: none; border-left: 3px solid #1a73e8; padding-left: 15px; margin-top: 10px; background: #f8fbff; padding: 10px; border-radius: 0 8px 8px 0; }
    </style>
</head>
<body>

<div class="address-card">
    <h2>Address Selection</h2>

    <div class="field">
        <label>Country</label>
        <select id="country"><option value="">Select Country</option></select>
    </div>

    <div class="field">
        <label id="stateLabel">State / Region</label>
        <select id="state" disabled><option value="">Select Country first</option></select>
    </div>

    <div class="field">
        <label>City / Municipal</label>
        <select id="city" disabled><option value="">Select State first</option></select>
    </div>

    <div id="brgyField" class="brgy-container">
        <div class="field">
            <label>Barangay</label>
            <select id="barangay"><option value="">Select Barangay</option></select>
        </div>
    </div>

    <div class="field">
        <label>Zip Code / Postal Code</label>
        <input type="text" id="zipcode" placeholder="Enter Zip Code">
    </div>
</div>

<script>
    const API_KEY = "1c82088bdd363775751dfe7419cb45e5d36299cd289c5b490e8f0ffdf5455960";
    const GLOBAL_URL = "https://api.countrystatecity.in/v1";
    const PH_URL = "https://psgc.gitlab.io/api";

    const dom = {
        country: document.getElementById('country'),
        state: document.getElementById('state'),
        city: document.getElementById('city'),
        brgy: document.getElementById('barangay'),
        brgyContainer: document.getElementById('brgyField'),
        stateLabel: document.getElementById('stateLabel')
    };

    const headers = new Headers();
    headers.append("X-CSCAPI-KEY", API_KEY);

    // 1. Load All Countries
    async function loadCountries() {
        try {
            const res = await fetch(`${GLOBAL_URL}/countries`, { headers });
            const data = await res.json();
            data.forEach(c => dom.country.add(new Option(c.name, c.iso2)));
        } catch (e) { console.error("Error loading countries"); }
    }

    // 2. Load States/Regions
    dom.country.onchange = async () => {
        const ccode = dom.country.value;
        dom.state.disabled = true;
        dom.state.innerHTML = '<option>Loading...</option>';
        dom.brgyContainer.style.display = (ccode === 'PH') ? 'block' : 'none';
        dom.stateLabel.innerText = (ccode === 'PH') ? 'Region Number' : 'State / Province';

        const res = await fetch(`${GLOBAL_URL}/countries/${ccode}/states`, { headers });
        const states = await res.json();
        
        dom.state.innerHTML = '<option value="">Select State/Region</option>';
        states.forEach(s => dom.state.add(new Option(s.name, s.iso2)));
        dom.state.disabled = false;
    };

    // 3. Load Cities
    dom.state.onchange = async () => {
        const ccode = dom.country.value;
        const scode = dom.state.value;
        dom.city.disabled = true;
        dom.city.innerHTML = '<option>Loading...</option>';

        const res = await fetch(`${GLOBAL_URL}/countries/${ccode}/states/${scode}/cities`, { headers });
        const cities = await res.json();
        
        dom.city.innerHTML = '<option value="">Select City/Municipal</option>';
        cities.forEach(c => dom.city.add(new Option(c.name, c.name)));
        dom.city.disabled = false;
    };

    // 4. Philippine Barangay Logic (The "Bridge")
    dom.city.onchange = async () => {
        if (dom.country.value !== 'PH') return;

        dom.brgy.innerHTML = '<option>Loading Barangays...</option>';
        const cityName = dom.city.value;

        try {
            // Find PSGC code for the selected city name
            const cityListRes = await fetch(`${PH_URL}/cities-municipalities/`);
            const cityList = await cityListRes.json();
            
            // Try to match the name (flexible search)
            const matchedCity = cityList.find(c => cityName.toLowerCase().includes(c.name.toLowerCase()) || c.name.toLowerCase().includes(cityName.toLowerCase()));

            if (matchedCity) {
                const brgyRes = await fetch(`${PH_URL}/cities-municipalities/${matchedCity.code}/barangays/`);
                const barangays = await brgyRes.json();
                
                dom.brgy.innerHTML = '<option value="">Select Barangay</option>';
                barangays.sort((a,b) => a.name.localeCompare(b.name)).forEach(b => {
                    dom.brgy.add(new Option(b.name, b.name));
                });
            } else {
                dom.brgy.innerHTML = '<option value="">Barangay data unavailable</option>';
            }
        } catch (e) {
            dom.brgy.innerHTML = '<option value="">Error fetching data</option>';
        }
    };

    loadCountries();
</script>

</body>
</html>